# Connecting to a network and Pelion Device Management

<span class="notes">Before you begin this tutorial, please [build an MBL image and install it on your device](../first-image/index.html).</span>

This tutorial covers:

1. Setting up a connection over:
    * [Ethernet](#setting-up-an-ethernet-connection).
    * [Wi-Fi](#setting-up-a-wi-fi-connection).
    * [Cellular](#setting-up-a-cellular-connection).
1. Verifying that your device can connect to your Pelion Device Management account.

## Setting up an Ethernet connection

If your device is physically connected to an Ethernet network (that must have a DHCP server), then it automatically uses that network.

## Setting up a Wi-Fi connection

<span class="notes">NXP 8M Mini EVK devices do not currently support Wi-Fi.</span>

<span class="tips">**Tip**: We recommend [installing MBL CLI](../develop-apps/setting-up.html) and setting up a USB connection to the device. You can then discover the device and [use a shell](../develop-apps/usage.html#get-shell-access-ssh) to set up the Wi-Fi connection.</span>

Mbed Linux OS (MBL) uses **Connection Manager (ConnMan)** to manage Wi-Fi interfaces and connections. This page briefly reviews ConnMan and then explains how to use it to set up and manage Wi-Fi on MBL devices.

As an MBL developer, use ConnMan for all basic Wi-Fi operations, rather than interacting directly with the `wpa_supplicant` daemon or modifying the `wpa_supplicant.conf` file.

<span class="notes">**Note:** This page reviews only some of the commonly used ConnMan options, within the context of MBL. You may be interested in [the full ConnMan documentation](https://01.org/connman/documentation).</span>

### connmanctl

`connmanctl` is ConnMan's command-line interface (CLI) tool. It can operate in two modes:

* A noninteractive mode, where it runs a single command passed as arguments to `connmanctl`. For example, you can trigger an immediate run of the command `state`:

    ```
    # connmanctl state
      State = ready
      OfflineMode = False
      SessionMode = False
    ```

* An interactive shell for more extensive use. To enter the interactive shell, enter `connmanctl` without entering a specific command. For example, to start `connmanctl` in interactive mode and run the `agent on` command:

    ```
    # connmanctl
    connmanctl> agent on
    Agent registered
    ```

    Some operations, such as connecting to a protected wireless access point for the first time, may only be possible through the interactive mode. For example, any operation that requires entering passwords.

To see the available `connmanctl` commands, run `connmanctl help` (or just `help` in interactive mode).

<span class="tips">**Tip:** See the [`connmanctl` man page](https://www.mankier.com/1/connmanctl) for more information.</span>

### Configuration and state

ConnMan automates many network operations and configurations by interacting with other daemons (DNS, DHCP and others) and by keeping a settings file, service files and other autogenerated data in the `/config/user/connman/` folder.

The folder contains:

* `/config/user/connman/settings`: Current global and per-technology settings.
* `/config/user/connman/main.conf`: The main ConnMan configuration file. Currently, most parameters are set to their default values (commented out); the only set parameter is `PreferredTechnologies`, which prioritizes Ethernet interface default routes over the Wi-Fi interface when both are connected.
* Automatically generated **service profiles**. For each Wi-Fi network that ConnMan connects to, it creates a directory in `/config/user/connman` to hold connection-specific configuration, such as passphrases, to support auto-connect on boot. Initially (before ConnMan has connected to any networks), there are no service profiles defined.

    To see all service profiles:

    ```
    # cat /config/user/connman/*/settings
    ```

* For advanced connection configurations, you may manually generate service files and place them under `/config/user/connman` (see section [Connecting to a network using service configuration (provisioning) files](#service-configuration-files)). These are also known as *provisioning files*, and their file extensions must be `.config`.

### Enabling Wi-Fi

ConnMan classifies network interfaces by their **technology**, and configurations are generally applied to one or more technologies. Examples of ConnMan's technology classifications are `wifi` and `ethernet`.

By default, in MBL, all technologies managed by ConnMan are disabled to prevent unwanted wireless or wired communication. To enable Wi-Fi, run:

```
# connmanctl enable wifi
Enabled wifi
```

This command does not actually cause the device to connect to any Wi-Fi networks; you must still configure the network connection, as explained below.

### Scanning for available Wi-Fi networks and inspecting results

To scan for nearby Wi-Fi networks:

```
# connmanctl scan wifi
Scan completed for wifi
```

To list the available networks found (among other services):

```
# connmanctl services
    AndyAP5           wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none
    Edimax               wifi_a2b2a2b2a2b2_19999999_managed_wep
    mbed                 wifi_a1a1a1a1a1a1_91111111_managed_psk
    ourLocalNetwork      wifi_a0a0a0a0a0a0_41699999999e47_managed_ieee8021x
    Wired                gadget_000000000000_usb
```

The last command lists **all** available services. As you can see in the example output, there is also a `Wired` service (listed on the last line). The available Wi-Fi services are prefixed with `wifi_` and suffixed with the security protocol. For example:

* Open network (AndyAP5): `_managed_none` suffix.
* WEP protected network (Edimax): `_managed_wep` suffix.
* WPA/WPA2 Enterprise 802.1X: (ourLocalNetwork) `managed_ieee8021x` suffix.
* WPA/WPA2 Personal (also known as WPA-PSK): `_managed_psk` suffix.

To more closely inspect a service after scanning, use `connmanctl services <service_id>`. For example, when you look at a local Wi-Fi network:

```
root@imx7s-warp-mbl:~# connmanctl services wifi_a0a0a0a0a0a0_41699999999e47_managed_ieee8021x
/net/connman/service/wifi_a0a0a0a0a0a0_41699999999e47_managed_ieee8021x
  Type = wifi
  Security = [ ieee8021x ]
  State = idle
  Strength = 59
  Favorite = False
  Immutable = False
  AutoConnect = False
  Name = ourLocalWiFi
  Ethernet = [ Method=auto, Interface=wlan0, Address=A0:A0:A0:A0:A0:A0, MTU=1500 ]
  IPv4 = [  ]
  IPv4.Configuration = [ Method=dhcp ]
  IPv6 = [  ]
  IPv6.Configuration = [ Method=auto, Privacy=disabled ]
  Nameservers = [  ]
  Nameservers.Configuration = [  ]
  Timeservers = [  ]
  Timeservers.Configuration = [  ]
  Domains = [  ]
  Domains.Configuration = [  ]
  Proxy = [  ]
  Proxy.Configuration = [  ]
  Provider = [  ]
root@imx7s-warp-mbl:~#
```

### Connecting to an open (public) Wi-Fi network

To connect to a public open network (AndyAP5 in the example), run `connmanctl connect <service_id>` where `<service_id>` is a service ID obtained from the output of `connmanctl services`. For example:

```
# connmanctl connect wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none
[ 1321.787201] IPv6: ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
Connected wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none
# ifconfig
...
...
...
wlan0     Link encap:Ethernet  HWaddr A0:B1:A0:B1:A0:B1  
          inet addr:192.168.168.168  Bcast:192.168.168.168  Mask:255.255.255.0
          inet6 addr: fe80::fe80:fe80:fe80:fe80/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:18 errors:0 dropped:0 overruns:0 frame:0
          TX packets:40 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:1922 (1.8 KiB)  TX bytes:7189 (7.0 KiB)
```

After connecting to AndyAP5, the DHCP server assigns `wlan0` an IP address.

If you check the ConnMan configuration folder, you can see the service profile for this connection:

```
# ls -l /config/user/connman/
total 10
-rw-r--r--    1 root     root          5731 Oct 22 16:03 main.conf
-rw-------    1 root     root           138 Nov  6 14:12 settings
drwx------    2 root     root          1024 Nov  6 14:12 wifi_a0cc2b2ccb9b_416e64726f6964415035_managed_none
```

ConnMan automatically created the folder `wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none`. Inside are a data (binary) file and a settings text file. The text file is used when inspecting a service using the `services <service_id>` option introduced above and includes all current settings.

```
# ls -l /config/user/connman/wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none/
total 7
-rw-------    1 root     root          4096 Nov  6 14:12 data
-rw-------    1 root     root           272 Nov  6 14:12 settings
# cat /config/user/connman/wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none/settings
[wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none]
Name=AndyAP5
SSID=432432432432432
Frequency=2412
Favorite=true
AutoConnect=true
Modified=2018-11-06T14:12:25.981677Z
IPv4.method=dhcp
IPv4.DHCP.LastAddress=192.168.168.168
IPv6.method=auto
IPv6.privacy=disabled
```

Pay attention to the `AutoConnect=true` parameter. It means that ConnMan will automatically connects to this network on boot if it is the only existing service profile, as well as in a few other cases (when the access point is nearby, and a few other configurations are applied).

You can change this file by using `connmanctl config <config_data>`, or by editing it manually.

### Connecting to a protected network interactively

1. Disconnect from any currently connected Wi-Fi networks. For example, if you were connected to the AndyAP5 network from the example above:

    ```
    # connmanctl disconnect wifi_a0b1a0b1a0b1a0b1_416416416416416_managed_none
    ```

1. Start `connmanctl` in interactive mode, and:

   1. Enable ConnMan's wireless **agent**, used for entering passphrases, by using the `agent on` command.
   1. Connect to the protected Wi-Fi network using the `connect` command, entering the passphrase when prompted.

   In this example, you connect to the Edimax WEP network from the `connmanctl services` listing above:

   ```
   # connmanctl
   connmanctl> agent on
   Agent registered
   connmanctl> connect wifi_a2b2a2b2a2b2_19999999_managed_wep
   Agent RequestInput wifi_a2b2a2b2a2b2_19999999_managed_wep
     Passphrase = [ Type=wep, Requirement=mandatory ]
   Passphrase? XXXXXXXXXX
   connmanctl> [  146.007791] IPv6: ADDRCONF(NETDEV_CHANGE): wlan0: link becomes ready
   Connected wifi_a2b2a2b2a2b2_19999999_managed_wep
   ```

<span class="notes">**Note:** ConnMan does not support password encryption.</span>

<h4 id="service-configuration-files">Connecting to a network using service configuration (provisioning) files</h4>

For advanced configuration, use a provisioning file (with the extension `.config`). Configurations include secured wireless access points that need complex authentication (such as WPA2 Enterprise), static IPs and so on. Each provisioning file can be used for multiple services at once.

For more information, refer to the [connman-service.config man page](https://manpages.debian.org/testing/connman/connman-service.config.5.en.html).

### Connecting to a Wi-Fi WPA/WPA2 enterprise network

1. Disable Wi-Fi:

  ```
  # connmanctl disable wifi
  ```

1. Create a configuration provisioning file at `/config/user/connman/<name>.config`.

    <span class="tips">**Tip:** You can add the `-service` suffix to file names as a convention. For example, `name-service`.</span>

1. Add service information to the configuration file:

  ```
  [global]
  Name = my-ssid
  Description = Provide a short description

  [service_wifi_local_network]
  Type = wifi
  Name = <my-ssid>
  EAP = peap
  Phase2 = MSCHAPV2
  Identity = <my-username>
  Passphrase = <my-password>
  ```

  Replace `<my-ssid>`, `<my-username>`, and `<my-password>` with the appropriate information, and amend the description.

1. Re-enable Wi-Fi:

  ```
  # connmanctl enable wifi
  ```

ConnMan now connects to the specified network.

If you experience any issues, restart both ConnMan and `wpa_supplicant` daemons.

### Troubleshooting WiFi connections

When connecting, the network name you use in the command must match the real network name exactly, including capitalisation and without trailing characters. Otherwise, you may get the following error:

`Error /net/connman/service/WIFI_NAME: Method "Connect" with signature "" on interface "net.connman.Service" doesn't exist`

## Setting up a cellular connection

<span class="notes">**Note**: cellular support was tested on the Raspberry Pi3 B/B+.</span>

### Hardware configuration

<img src="https://s3-us-west-2.amazonaws.com/mbed-linux-os-docs-images/cellular_hardware.jpg" width="50%" align="right" />

Required hardware: [sixfab evaluation board with Quectel EC25 cellular modem](https://sixfab.com/product/raspberry-pi-4g-lte-shield-kit/).

You must disable the SIM pin enquiry before inserting the SIM card.

### Software configuration

To establish a cellular connection, use the Ethernet Control Model (ECM) mode to connect to the device over USB. ECM is activated using AT commands (detailed below). For the Raspberry Pi 3B/B+, the modem interface appears on `ifconfig` as `usb0`.

### Activating ECM with AT commands

<span class="tips">This example uses the microcom terminal to send AT commands to the modem.</span>

**To activate ECM:**

The activation of ECM mode is only needed once: the change is saved in NV (non-volatile) memory in the modem.

1. Open a serial interface to the EC25 modem:

    ```
    # microcom /dev/ttyUSB2
    ```

1. microcom doesn't give any feedback once connected. To check it is working type `at` and it should respond `OK`

    ```
    # microcom /dev/ttyUSB2
    at
    OK
    ```

1. Check whether or not ECM is already active:

    ```
    at+qcfg="usbnet"
    ```

    The response will be `+qcfg: "ubsnet",x`

    If x is `0`, ECM is not active.

1. Activate ECM:

    ```
    at+qcfg="usbnet",1
    ```

    And wait for the `OK` response.

1. Power cycle the modem:

    ```
    at+qpowd
    ```

    It may take some time to get the response `OK POWERED DOWN`.

1. When ECM is activated, you will see the following kernel messages:

    ```
    [    503.173904] usb 1-1.3: USB disconnect, device number 5
    [    503.179829] option1 ttyUSB0: GSM modem (1-port) converter now disconnected from ttyUSB0
    [    503.191543] option 1-1.3:1.0: device disconnected
    [    503.197298] option1 ttyUSB1: GSM modem(1-port) converter now disconnected from ttyUSB1
    [    503.208974] option 1-1.3:1.1: device disconnected
    [    503.216097] option1 ttyUSB2: GSM modem (1-port) converter now disconnected from ttyUSB2
    [    503.228136] option 1-1.3:1.2: device disconnected
    [    503.233799] option1 ttyUSB3: GSM modem (1-port) converter now disconnected from ttyUSB3
    [    503.245459] option 1-1.3:1.3: device disconnected
    [    503.250863] qmi_wwan 1-1.3:1.4 wwan0: unregister 'qmi_wwan' usb-3f980000.usb-1.3, WWAN/QMI device
    [    516.013299] usb 1-1.3: new high-speed USB device number 6 using dwc_otg
    [    516.153487] usb 1-1.3: New USB device found, idVendor=2c7c, idProduct=0125
    [    516.160485] usb 1-1.3: New USB device strings: Mfr=1, Product=2, SerialNumber=0
    [    516.167962] usb 1-1.3: Product: Android[    516.171876] usb 1-1.3: Manufacturer: Android
    [    516.177884] option 1-1.3:1.0: GSM modem (1-port) converter detected
    [    516.184794] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB0
    [    516.192544] option 1-1.3:1.1: GSM modem (1-port) converter detected
    [    516.199382] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB1
    [    516.207241] option 1-1.3:1.2: GSM modem (1-port) converter detected
    [    516.214110] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB2
    [    516.221878] option 1-1.3:1.3: GSM modem (1-port) converter detected
    [    516.228632] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB3
    [    516.241350] cdc_ether 1-1.3:1.4 usb0: register 'cdc_ether' at usb-3f980000.usb-1.3, CDC Ethernet Device, fe:54:59:9c:81:6b
    [    516.243570] cdc_ether 1-1.3:1.4 usb0: kevent 12 may have been dropped
    [    516.252855] cdc_ether 1-1.3:1.4 usb0: kevent 11 may have been dropped
    [    516.374254] cdc_ether 1-1.3:1.4 usb0: kevent 12 may have been dropped
    [    516.380811] cdc_ether 1-1.3:1.4 usb0: kevent 12 may have been dropped
    [    516.391067] IPv6: ADDRCONF(NETDEV_UP): usb0: link is not ready
    [    518.354870] IPv6: ADDRCONF(NETDEV_CHANGE): usb0: link becomes ready
    [    518.361271] cdc_ether 1-1.3:1.4 usb0: kevent 12 may have been dropped
    [    518.367866] cdc_ether 1-1.3:1.4 usb0: kevent 12 may have been dropped
    ```    

1. Check that ECM is working by verifying a valid IP address on the interface and by pinging a website, for example www.google.com:

    ```
    # ifconfig usb0
    usb0  Link encap:Ethernet  HWaddr 46:1C:33:88:26:11  
          inet addr:192.168.225.37  Bcast:192.168.225.255  Mask:255.255.255.0
          inet6 addr: fe80::441c:33ff:fe88:2611/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1918 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2141 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:177877 (173.7 KiB)  TX bytes:197501 (192.8 KiB)
    # ping -I usb0 www.google.com
      PING www.google.com (216.58.213.100): 56 data bytes
      64 bytes from 216.58.213.100: seq=0 ttl=51 time=168.265 ms
      64 bytes from 216.58.213.100: seq=1 ttl=51 time=60.287 ms
      64 bytes from 216.58.213.100: seq=2 ttl=51 time=59.877 ms
      64 bytes from 216.58.213.100: seq=3 ttl=51 time=58.314 ms
    ```

### Connecting and disconnecting the cellular connection using ConnMan

Once the ECM is up and running, ConnMan can connect and disconnect the cellular connection. To identify the right service you need the MAC address of the network interface, which is used to name the Connman service. In the example above, the address is `46:1C:33:88:26:11`, and the derived service name is `ethernet_461c33882611_cable`.

**To disconnect:**

1. List all ConnMan services:

   ```
   # connmanctl services
   *AO Wired                ethernet_461c33882611_cable
   *AR Wired                ethernet_de5e17ac558d_cable
   ```
1. Disconnect cellular connection:

   ```
   # connmanctl disconnect ethernet_461c33882611_cable
   ```
1. Check that `usb0` doesn't have an IP address anymore:

   ```
   # ifconfig usb0
   usb0      Link encap:Ethernet  HWaddr 46:1C:33:88:26:11  
             inet6 addr: fe80::441c:33ff:fe88:2611/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:2072 errors:0 dropped:0 overruns:0 frame:0
             TX packets:2339 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:183673 (179.3 KiB)  TX bytes:211149 (206.2 KiB)
   ```

**To reconnect:**

1. Connect cellular connection:

   ```
   # connmanctl connect ethernet_461c33882611_cable
   Connected ethernet_461c33882611_cable
   ```

1. Check whether the cellular connection has reconnected by pinging an external website.

### Deactivate ECM with AT commands

If you need to deactivate the ECM mode, you can use AT commands as detailed below. You only need to do this once; the change is stored in the modem's NV (non-volatile) memory.

**To deactivate ECM:**

1. Open a serial interface to the EC25 modem:

    ```
    # microcom /dev/ttyUSB2
    ```

1. Enter:

    ```
    at+qcfg="usbnet",0
    ```

    And wait for the `OK` response.

1. Power cycle the modem:

    ```
    at+qpowd
    ```

    It may take some time to get the response `OK POWERED DOWN`.

1. When ECM is deactivated, you will see the following kernel messages:

    ```
    [    344.769511] option1 ttyUSB3: GSM modem (1-port) converter now disconnected from ttyUSB3
    [    344.781101] option 1-1.3:1.3: device disconnected
    [    344.786296] cdc_ether 1-1.3:1.4 usb0: unregister 'cdc_ether' usb-3f980000.usb-1.3, CDC Ethernet Device
    [    344.826839] IPv6: ADDRCONF(NETDEV_UP): eth0: link is not ready
    [    344.832874] IPv6: ADDRCONF(NETDEV_UP): wlan0: link is not ready
    [    357.544005] usb 1-1.3: new high-speed USB device number 5 using dwc_otg
    [    357.684252] usb 1-1.3: New USB device found, idVendor=2c7c, idProduct=0125
    [    357.691249] usb 1-1.3: New USB device strings: Mfr=1, Product=2, SerialNumber=0
    [    357.698723] usb 1-1.3: Product: Android
    [    357.702637] usb 1-1.3: Manufacturer: Android
    [    357.708371] option 1-1.3:1.0: GSM modem (1-port) converter detected
    [    357.715347] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB0
    [    357.723079] option 1-1.3:1.1: GSM modem (1-port) converter detected
    [    357.729918] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB1
    [    357.737798] option 1-1.3:1.2: GSM modem (1-port) converter detected
    [    357.744601] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB2
    [    357.752391] option 1-1.3:1.3: GSM modem (1-port) converterdetected
    [    357.759201] usb 1-1.3: GSM modem (1-port) converter now attached to ttyUSB3
    [    357.767804] qmi_wwan 1-1.3:1.4: cdc-wdm0: USB WDM device
    [    357.774595] qmi_wwan 1-1.3:1.4 wwan0: register 'qmi_wwan' at usb-3f980000.usb-1.3, WWAN/QMI device, da:b3:ca:ab:e7:30
    ```
